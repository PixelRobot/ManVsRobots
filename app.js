function runGame(){function t(t,i){return Math.floor(Math.random()*(i-t+1))+t}function e(){var i=t(0,G.m),e=t(0,G.n);return{x:i,y:e}}function r(t,i,e){var r=e.offsetx+Math.floor((p.width-e.width)/2)-2,s=e.offsety+Math.floor((p.height-e.height)/2)-2,n=r+e.width+4,o=s+e.height+4;return t>=r&&n>=t&&i>=s&&o>=i?!0:!1}function s(t,i){var e=t.getBoundingClientRect();return{x:Math.floor(i.clientX-e.left),y:Math.floor(i.clientY-e.top)}}function n(){for(var t in Mi){var i=Mi[t].x,e=Mi[t].y;a(O.x+i,O.y+e)&&null!=Mi[t].piece&&(O.x+i==X&&O.y+e==Y?(ki.piecePos(O.x+i,O.y+e,Mi[t].piece),ki.piecePos(X,Y,li),D=!0):ki.piecePosShift(O.x+i,O.y+e,Mi[t].piece,248))}O.x==X&&O.y==Y&&(ki.piecePos(X,Y,li),D=!0)}function o(){0==D?ki.pieceCart(T,L,di):ki.pieceCartShift(T,L,di,12)}function a(t,i){for(var e in B.list)if(B.list[e].x==t&&B.list[e].y==i)return!1;for(var e in H.list)if(H.list[e].x==t&&H.list[e].y==i)return!1;return!0}function f(t,i){return Math.abs(O.x-t)<=1&&Math.abs(O.y-i)<=1&&a(t,i)?!0:!1}function h(){w.src="sprites.png",m.src="text.png",g.src="lettering.png",v.src="cheer.mp3",P.src="crash.mp3",C.src="scream.mp3",q.src="servo.mp3",M.src="teleport.mp3",k.src="walk.mp3",w.onload=d,m.onload=d,g.onload=d,v.onloadeddata=d,P.onloadeddata=d,C.onloadeddata=d,q.onloadeddata=d,M.onloadeddata=d,k.onloadeddata=d}function c(){var t=Math.floor(p.width/2),i=Math.floor(p.height/2);x.fillStyle="#000",x.fillRect(0,0,p.width,p.height),x.fillStyle="#FFF",x.fillRect(t-50,i-10,100,10),x.fillStyle="#000",x.fillRect(t-48,i-8,96,6),F>0?(x.fillStyle="#C00",x.fillRect(t-46,i-6,Math.floor(92/I*(I-F)),2)):(x.fillStyle="#0C0",x.fillRect(t-46,i-6,92,2))}function d(){F--,c(),0==F&&(b=ui,u())}function l(t){var i=e();O.x=i.x,O.y=i.y,B.list=[],H.list=[];for(var r=0;t>r;r++){do{i=e();var s={x:i.x,y:i.y}}while(!a(s.x,s.y)||s.x==O.x&&s.y==O.y);B.list.push(s)}}function u(){requestAnimFrame(u);var t=Date.now()-bi;Fi>Ii?(Fi=0,b.run(),console.info(b.id)):Fi+=t,bi=Date.now()}var y={id:"empty",init:function(){return this},run:function(){}},p=document.getElementById("myCanvas");p.width=480,p.height=320,p.style.cursor="none";var x=p.getContext("2d"),w=new Image,m=new Image,g=new Image,v=new Audio,P=new Audio,C=new Audio,q=new Audio,M=new Audio,k=new Audio,b=y.init(),F=9,I=F,A=[2,6,12,20,26,30,32],R=!1,S=!0,E=0,T=p.width,L=p.height,X=T,Y=L,D=!1;if("github.io"!=document.domain.split(".").slice(-2).join("."))return null;p.addEventListener("click",function(t){D=!1;var i=s(p,t);if("playing"==b.id)clickX=Math.floor(i.x/G.square),clickY=Math.floor(i.y/G.square),f(clickX,clickY)&&(O.x!=clickX||O.y!=clickY?0==R&&(b=mi.init(clickX,clickY)):0==R&&(b=gi.init()));else if("menu"==b.id)if("main"==b.page)r(i.x,i.y,z)?b.setPage("options"):r(i.x,i.y,j)&&(E=0,b=xi.init());else{if(S)var e=Q;else var e=V;r(i.x,i.y,J)?b.setPage("main"):(r(i.x,i.y,K)||r(i.x,i.y,e))&&(S=S?!1:!0)}},!1),window.addEventListener("keydown",function(t){D=!1;var i=t.keyCode;if("empty"!=b.id&&"loaded"!=b.id&&"logo"!=b.id&&"menu"!=b.id&&t.preventDefault(),"playing"==b.id&&0==R){switch(i){case 35:case 97:console.info("DOWNLEFT");var e=-1,r=1;break;case 40:case 98:console.info("DOWN");var e=0,r=1;break;case 34:case 99:console.info("DOWNRIGHT");var e=1,r=1;break;case 37:case 100:console.info("LEFT");var e=-1,r=0;break;case 12:case 101:return console.info("TELEPORT"),b=gi.init(),0;case 39:case 102:console.info("RIGHT");var e=1,r=0;break;case 36:case 103:console.info("UPLEFT");var e=-1,r=-1;break;case 38:case 104:console.info("UP");var e=0,r=-1;break;case 33:case 105:console.info("UPRIGHT");var e=1,r=-1}var s=O.x+e,n=O.y+r;console.info(s+";"+n),s>-1&&n>-1&&s<=G.m&&n<=G.n&&a(s,n)&&(b=mi.init(s,n))}else"menu"==b.id&&13==i&&(E=0,b=xi.init())},!1);var G={m:p.width/32-1,n:p.height/32-1,color1:"#68A",color2:"#79B",square:32,draw:function(){for(var t=0;t<=this.m;t++)for(var i=0;i<=this.n;i++)x.fillStyle=(t+i)%2==0?this.color1:this.color2,x.fillRect(this.square*t,this.square*i,this.square,this.square)},adjust:function(){this.m=p.width/32-1,this.n=p.height/32-1},collisions:function(){var t={},i=new Array,e="";for(var r in B.list)e="x"+B.list[r].x+"y"+B.list[r].y,void 0==t[e]?(t[e]=1,i.push(B.list[r])):t[e]=t[e]+1;B.list=i,i=new Array;for(var r in B.list){if(e="x"+B.list[r].x+"y"+B.list[r].y,1==t[e]){fire=!1;for(var s in H.list)B.list[r].x==H.list[s].x&&B.list[r].y==H.list[s].y&&(fire=!0);fire||i.push(B.list[r])}else H.list.push(B.list[r]);if(O.x==B.list[r].x&&O.y==B.list[r].y){S&&C.play();for(var s=r;s<B.list.length;s++)i.push(B.list[s]);break}}B.list=i,0==B.list.length&&a(O.x,O.y)&&S&&v.play()}},O={readx:24,ready:0,width:20,height:24,offsetx:6,offsety:4,src:w,move:function(t,i){this.old={x:this.x,y:this.y},this.x=t,this.y=i},teleport:function(){this.old={x:this.x,y:this.y};var t=e();this.x=t.x,this.y=t.y},x:G.m,y:G.n,old:null},B={readx:0,ready:0,width:24,height:24,offsetx:4,offsety:4,src:w,draw:function(){},ai:function(){var t=new Array;for(var i in this.list){var e=G.m*G.m+G.n*G.n,r=null;for(var s in Mi){var n=this.list[i].x+Mi[s].x-O.x,o=this.list[i].y+Mi[s].y-O.y,a=n*n+o*o;e>a&&(e=a,r={x:Mi[s].x,y:Mi[s].y})}t.push({x:this.list[i].x+r.x,y:this.list[i].y+r.y})}return t},move:function(){this.old=this.list,this.list=B.ai()},list:[],old:null},H={readx:[244,268],ready:0,width:24,height:24,offsetx:4,offsety:4,src:w,list:[]};p.addEventListener("mousemove",function(t){if(mousePos=s(p,t),T=mousePos.x,L=mousePos.y,X=Math.floor(mousePos.x/G.square),Y=Math.floor(mousePos.y/G.square),"playing"==b.id)clickX=Math.floor(T/G.square),clickY=Math.floor(L/G.square),D=f(clickX,clickY)?!0:!1;else if("menu"==b.id)if("main"==b.page)D=r(T,L,z)||r(T,L,j)?!0:!1;else{if(S)var i=Q;else var i=V;D=r(T,L,J)||r(T,L,K)||r(T,L,i)?!0:!1}},!1);var N={readx:0,ready:0,width:220,height:96,offsetx:0,offsety:0,src:g},U={readx:0,ready:96,width:94,height:10,offsetx:0,offsety:65,src:g},W={readx:0,ready:106,width:264,height:173,offsetx:0,offsety:-40,src:g},j={readx:0,ready:279,width:46,height:10,offsetx:0,offsety:70,src:g},z={readx:0,ready:289,width:82,height:10,offsetx:0,offsety:100,src:g},J={readx:0,ready:299,width:58,height:10,offsetx:0,offsety:30,src:g},K={readx:0,ready:309,width:58,height:10,offsetx:0,offsety:0,src:g},Q={readx:60,ready:309,width:22,height:10,offsetx:54,offsety:0,src:g},V={readx:84,ready:309,width:34,height:10,offsetx:60,offsety:0,src:g},Z={readx:242,ready:309,width:22,height:10,offsetx:145,offsety:35,src:g},$={readx:44,ready:0,width:24,height:24,offsetx:4,offsety:4,src:w},_={readx:68,ready:0,width:24,height:24,offsetx:4,offsety:4,src:w},ti={readx:92,ready:0,width:24,height:24,offsetx:4,offsety:4,src:w},ii={readx:116,ready:0,width:24,height:24,offsetx:4,offsety:4,src:w},ei={readx:140,ready:0,width:20,height:20,offsetx:6,offsety:6,src:w},ri={readx:160,ready:0,width:20,height:20,offsetx:6,offsety:6,src:w},si={readx:180,ready:0,width:20,height:20,offsetx:6,offsety:6,src:w},ni={readx:200,ready:0,width:20,height:20,offsetx:6,offsety:6,src:w},oi={readx:220,ready:0,width:24,height:24,offsetx:4,offsety:4,src:w},ai={readx:0,ready:0,width:168,height:14,offsetx:0,offsety:0,src:m},fi={readx:0,ready:14,width:250,height:14,offsetx:0,offsety:0,src:m},hi={readx:0,ready:28,width:76,height:14,offsetx:0,offsety:0,src:m},ci={readx:94,ready:28,width:14,height:14,offsetx:64,offsety:0,src:m},di={readx:468,ready:0,width:12,height:16,offsetx:0,offsety:0,x:0,y:0,src:w},li={readx:492,ready:0,width:32,height:32,offsetx:0,offsety:0,src:w},ui={id:"loaded",frame:0,init:function(){return this},preprocess:function(){},draw:function(){this.frame%2==0?c():(x.fillStyle="#000",x.fillRect(0,0,p.width,p.height))},postprocess:function(){this.frame++},transit:function(){this.frame>5&&(b=yi.init())},run:function(){this.draw(),this.postprocess(),this.transit()}},yi={id:"logo",frame:0,init:function(){return this},preprocess:function(){},draw:function(){x.fillStyle="#FFFFFF",x.fillRect(0,0,p.width,p.height),this.frame<20&&(x.globalAlpha=.05*this.frame),ki.pieceCenter(N),x.globalAlpha=1,this.frame>25&&ki.pieceCenter(U)},postprocess:function(){this.frame++},transit:function(){this.frame>50&&(b=pi.init())},run:function(){this.draw(),this.postprocess(),this.transit()}},pi={id:"menu",page:"main",setPage:function(t){this.page=t},init:function(){return this.page="main",D=r(T,L,z)||r(T,L,j)?!0:!1,this},preprocess:function(){},draw:function(){x.fillStyle="#000000",x.fillRect(0,0,p.width,p.height),"main"==this.page?(ki.pieceCenter(W),ki.pieceCenter(j),ki.pieceCenter(z),ki.pieceCenter(Z)):(ki.pieceCenter(K),ki.pieceCenter(S?Q:V),ki.pieceCenter(J)),o()},postprocess:function(){},transit:function(){},run:function(){this.draw()}},xi={id:"begin",frame:0,init:function(){return E++,this.frame=1,l(E+4),this},preprocess:function(){},draw:function(){if(G.draw(),this.frame<7)ki.piecePartialCenter(hi,2*this.frame,"up"),ki.numberPartialCenter(E,2*this.frame,"up");else if(this.frame>=7&&this.frame<=20)ki.pieceCenter(hi),ki.numberCenter(E);else{var t=this.frame-20;for(var i in B.list)ki.piecePartial(B,B.list[i].x,B.list[i].y,2*t,"up");ki.piecePartial(O,O.x,O.y,2*t,"up")}20==this.frame&&S&&M.play()},postprocess:function(){this.frame++},transit:function(){this.frame>32&&(b=wi.init())},run:function(){this.draw(),this.postprocess(),this.transit()}},wi={id:"playing",init:function(){return R=!1,this},preprocess:function(){},draw:function(){G.draw(),ki.piece(O);for(var t in B.list)ki.piecePos(B.list[t].x,B.list[t].y,B);n(),qi.run(),o()},postprocess:function(){},transit:function(){},run:function(){this.draw()}},mi={id:"moving",frame:0,init:function(t,i){return R=!0,O.move(t,i),S&&k.play(),this.frame=0,this},preprocess:function(){},draw:function(){G.draw();for(var t in B.list)ki.piecePos(B.list[t].x,B.list[t].y,B);qi.run();var i=A[this.frame];ki.pieceShift(O,O.x,O.y,O.old.x,O.old.y,i)},postprocess:function(){this.frame++},transit:function(){this.frame>6&&(b=vi.init())},run:function(){this.draw(),this.postprocess(),this.transit()}},gi={id:"teleporting",frame:0,init:function(){return R=!0,O.teleport(),S&&M.play(),this.frame=1,this},preprocess:function(){},draw:function(){G.draw();for(var t in B.list)ki.piecePos(B.list[t].x,B.list[t].y,B);var i=2*this.frame;ki.piecePartial(O,O.x,O.y,i,"up"),ki.piecePartial(O,O.old.x,O.old.y,i,"down"),qi.run()},postprocess:function(){this.frame++},transit:function(){this.frame>11&&(b=a(O.x,O.y)?vi.init():Pi.init())},run:function(){this.draw(),this.postprocess(),this.transit()}},vi={id:"theirturn",frame:0,init:function(){return B.old=B.list,B.list=B.ai(),S&&q.play(),this.frame=0,this},preprocess:function(){},draw:function(){G.draw(),ki.piece(O),qi.run();for(var t in B.list){var i=A[this.frame];ki.pieceShift(B,B.list[t].x,B.list[t].y,B.old[t].x,B.old[t].y,i)}},postprocess:function(){this.frame++},transit:function(){if(this.frame>6){var t=B.list.length;G.collisions(),t!=B.list.length&&S&&P.play(),b=a(O.x,O.y)?0==B.list.length?Ci.init():wi.init():Pi.init()}},run:function(){this.draw(),this.postprocess(),this.transit()}},Pi={id:"dead",frame:1,init:function(){return S&&C.play(),this.frame=1,this},preprocess:function(){},draw:function(){G.draw();for(var t in B.list)(B.list[t].x!=O.x||B.list[t].y!=O.y)&&ki.piecePos(B.list[t].x,B.list[t].y,B);qi.run(),ki.piecePos(O.x,O.y,oi),this.frame<7?ki.piecePartialCenter(fi,2*this.frame,"up"):ki.pieceCenter(fi)},postprocess:function(){this.frame++},transit:function(){this.frame>20&&(b=pi.init())},run:function(){this.draw(),this.postprocess(),this.transit()}},Ci={id:"victory",frame:1,init:function(){return this.frame=1,this},preprocess:function(){},draw:function(){G.draw();for(var t in B.list)(B.list[t].x!=O.x||B.list[t].y!=O.y)&&ki.piecePos(B.list[t].x,B.list[t].y,B);qi.run(),ki.piece(O),this.frame<7?ki.piecePartialCenter(ai,2*this.frame,"up"):ki.pieceCenter(ai)},postprocess:function(){this.frame++},transit:function(){this.frame>20&&(b=xi.init())},run:function(){this.draw(),this.postprocess(),this.transit()}},qi={frame:0,index:0,init:function(){return this},preprocess:function(){this.index=this.frame<2?0:1},draw:function(){for(var t in H.list)(H.list[t].x!=O.x||H.list[t].y!=O.y)&&ki.pieceFramePos(H.list[t].x,H.list[t].y,H,this.index)},postprocess:function(){this.frame=(this.frame+1)%4},transit:function(){},run:function(){this.preprocess(),this.draw(),this.postprocess()}},Mi=new Array({x:0,y:-1,piece:$},{x:1,y:-1,piece:ri},{x:1,y:0,piece:_},{x:1,y:1,piece:si},{x:0,y:1,piece:ti},{x:-1,y:1,piece:ni},{x:-1,y:0,piece:ii},{x:-1,y:-1,piece:ei},{x:0,y:0,piece:null}),ki={piecePos:function(t,i,e){x.drawImage(e.src,e.readx,e.ready,e.width,e.height,e.offsetx+G.square*t,e.offsety+G.square*i,e.width,e.height)},piecePosShift:function(t,i,e,r){x.drawImage(e.src,e.readx+r,e.ready,e.width,e.height,e.offsetx+G.square*t,e.offsety+G.square*i,e.width,e.height)},pieceCart:function(t,i,e){x.drawImage(e.src,e.readx,e.ready,e.width,e.height,e.offsetx+t,e.offsety+i,e.width,e.height)},pieceCartShift:function(t,i,e,r){x.drawImage(e.src,e.readx+r,e.ready,e.width,e.height,e.offsetx+t,e.offsety+i,e.width,e.height)},piece:function(t){ki.piecePos(t.x,t.y,t)},pieceFramePos:function(t,i,e,r){x.drawImage(e.src,e.readx[r],e.ready,e.width,e.height,e.offsetx+G.square*t,e.offsety+G.square*i,e.width,e.height)},pieceCenter:function(t){x.drawImage(t.src,t.readx,t.ready,t.width,t.height,t.offsetx+Math.floor((p.width-t.width)/2),t.offsety+Math.floor((p.height-t.height)/2),t.width,t.height)},pieceShift:function(t,i,e,r,s,n){var o=n*(i-r),a=n*(e-s);x.drawImage(t.src,t.readx,t.ready,t.width,t.height,G.square*r+o+t.offsetx,G.square*s+a+t.offsety,t.width,t.height)},piecePartial:function(t,i,e,r,s){switch(s){case"up":var n=t.height-r;x.drawImage(t.src,t.readx,t.ready+n,t.width,r,G.square*i+t.offsetx,G.square*e+t.offsety+n,t.width,r);break;case"down":x.drawImage(t.src,t.readx,t.ready,t.width,t.height-r,G.square*i+t.offsetx,G.square*e+t.offsety,t.width,t.height-r)}},piecePartialCenter:function(t,i,e){switch(e){case"up":var r=t.height-i;x.drawImage(t.src,t.readx,t.ready+r,t.width,i,t.offsetx+Math.floor((p.width-t.width)/2),t.offsety+Math.floor((p.height-t.height)/2)+r,t.width,i);break;case"down":x.drawImage(t.src,t.readx,t.ready,t.width,t.height-i,t.offsetx+Math.floor((p.width-t.width)/2),t.offsety+Math.floor((p.height-t.height)/2),t.width,t.height-i)}},numberCenter:function(t){var e=t.toString();for(i in e)x.drawImage(ci.src,ci.readx+16*e[i],ci.ready,ci.width,ci.height,ci.offsetx+Math.floor((p.width-ci.width)/2)+16*i,ci.offsety+Math.floor((p.height-ci.height)/2),ci.width,ci.height)},numberPartialCenter:function(t,e,r){var s=t.toString();switch(r){case"up":var n=ci.height-e;for(i in s)x.drawImage(ci.src,ci.readx+16*s[i],ci.ready+n,ci.width,e,ci.offsetx+Math.floor((p.width-ci.width)/2)+16*i,ci.offsety+Math.floor((p.height-ci.height)/2)+n,ci.width,e);break;case"down":for(i in s)x.drawImage(ci.src,ci.readx+16*s[i],ci.ready,ci.width,ci.height-e,ci.offsetx+Math.floor((p.width-ci.width)/2)+16*i,ci.offsety+Math.floor((p.height-ci.height)/2),ci.width,ci.height-e)}}},bi=0,Fi=0,Ii=50;window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)}}(),h()}